name: Terraform Deploy

on:
  push:
    branches: 
      - main
      - staging
      - dev
  workflow_dispatch: 

permissions:
  id-token: write
  contents: read

jobs:
  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Debug Environment
        run: echo "Deploying to ${{ github.job }} in ${{ github.environment }} environment"

      # Azure login steps (dev/staging/prod) omitted for brevity â€” keep as-is from your workflow

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # --- Security Scanning ---
      - name: Install TFSec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run TFSec Scan
        run: tfsec ./terraform

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov Scan
        run: checkov -d ./terraform --quiet

      # --- Terraform Deploy ---
      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: # Terraform Validate
        run: terraform validate
        working-directory: ./terraform

      - name: Terraform Plan
        run: terraform plan -out=tfplan -var="environment=${{ github.ref_name }}"
        working-directory: ./terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
